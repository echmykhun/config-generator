/**
 * Created by yevhen_chmykhun on 13.10.15.
 */

var constants = require('./../constants.json');
var util = require('./../util');

module.exports = function (gen, next) {

  var generator = gen, nextPrompt = next;

  var updateModelsAllowedAttrsPrompt = function () {
    var updateModelsAllowedAttrsPromiseFunc = function (resolve, reject) {
      var updateModelsAllowedAttrsPromptOptions = {
        type: 'list',
        name: 'model',
        message: 'Update models allowed fields \n Enter model name(none to proceed)',
        choices: generator.modelNames,
        default: generator.modelNames[0]
      };
      var updateModelsAllowedAttrsPromptCallback = function (answers) {
        var modelName = answers.model;
        if (modelName != "none") {
          generator.tablesColumnsFakerType[modelName] = {};
          var modelFields = Object.keys(generator.models[modelName].columns);
          modelFields.push("none");
          resolve({modelName: modelName, modelFields: modelFields})
        } else {
          generator.configObject['updateModelsAllowedAttrs'] = generator.updateModelsAllowedAttrs;
          util.saveConfig(generator.configObject, generator.configFileName);
          resolve(false);
        }
      };
      generator.prompt(updateModelsAllowedAttrsPromptOptions, updateModelsAllowedAttrsPromptCallback);
    };
    return new Promise(updateModelsAllowedAttrsPromiseFunc).then(afterUpdateModelsAllowedAttrsPrompt);
  };
  var afterUpdateModelsAllowedAttrsPrompt = function (params) {
    if (params) {
      return updateModelsAllowedAttrsFieldsPrompt(params);
    } else {
      return nextPrompt ? nextPrompt() : false
    }
  };
  var updateModelsAllowedAttrsFieldsPrompt = function (params) {
    var updateModelsAllowedAttrsFieldsPromiseFunc = function (resolve, reject) {
      var updateModelsAllowedAttrsFieldsPromptOptions = {
        type: 'list',
        name: 'field',
        message: 'Enter field name(none to proceed)',
        choices: params.modelFields,
        default: params.modelFields[0]
      };
      var updateModelsAllowedAttrsFieldsPromptCallback = function (answer) {
        var field = answer.field;
        params.field = field;
        if (field != "none") {
          if (!generator.updateModelsAllowedAttrs[params.modelName]) generator.updateModelsAllowedAttrs[params.modelName] = [];
          generator.updateModelsAllowedAttrs[params.modelName].push(field);
        }
        resolve(params);
      };
      generator.prompt(updateModelsAllowedAttrsFieldsPromptOptions, updateModelsAllowedAttrsFieldsPromptCallback);
    };
    return new Promise(updateModelsAllowedAttrsFieldsPromiseFunc).then(afterUpdateModelsAllowedAttrsFieldsPrompt);
  };
  var afterUpdateModelsAllowedAttrsFieldsPrompt = function (params) {
    if (params.field != "none") {
      return updateModelsAllowedAttrsFieldsPrompt(params);
    } else {
      return updateModelsAllowedAttrsPrompt();
    }
  };

  return updateModelsAllowedAttrsPrompt;
};